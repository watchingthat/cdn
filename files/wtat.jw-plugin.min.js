!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.wtAdTracer=e()}(this,function(){"use strict";function d(t,r){var a=t;return function(){if(r)try{for(var t,e=arguments.length,i=Array(e),n=0;n<e;n++)i[n]=arguments[n];(t=console).warn.apply(t,["%c"+a,"background:#ffd400;color:#000;padding:2px"].concat(i))}catch(t){}}}var h=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},c=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t},o={endpoint:"https://c.watchingthat.com/event",batchSize:5,batchInterval:1e3,debug:!1},i={0:[]},n=0,t=void 0,e=!1,r=!1,s=function(){};function a(){0<o.batchInterval&&(t=setInterval(p,o.batchInterval))}function l(){clearInterval(t)}function p(){if(!e){e=!0,l();var t=n;i[n+1]=[],n++,i[t].length&&function(t,e){s("sending",t);try{var i=JSON.stringify(t);if(navigator.sendBeacon){var n=new FormData;n.append("batch",i);var r=navigator.sendBeacon(o.endpoint,n);r||s("beacon queue error"),u(e)}else{var a=new XMLHttpRequest;a.open("POST",o.endpoint,!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.onreadystatechange=function(){u(e)},a.send("batch="+encodeURIComponent(i))}}catch(t){s("xhr error",t.message)}}(i[t],t),e=!1,a()}}function u(t){delete i[t]}var g=function(){function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};h(this,e),o=c(o,t),s=d.call(null,"WTAT.stream",o.debug),a()}return e.prototype.push=function(t){r||(s("received",t),i[n].push(t),i[n].length>=o.batchSize&&p())},e.prototype.stop=function(){r=!0,i[n].length&&p(),l()},e}(),f=function(){};function y(t){var e={width:1/0,height:1/0,area:1/0};return!isNaN(t.document.body.clientWidth)&&0<t.document.body.clientWidth&&(e.width=t.document.body.clientWidth),!isNaN(t.document.body.clientHeight)&&0<t.document.body.clientHeight&&(e.height=t.document.body.clientHeight),t.document.documentElement&&t.document.documentElement.clientWidth&&!isNaN(t.document.documentElement.clientWidth)&&(e.width=t.document.documentElement.clientWidth),t.document.documentElement&&t.document.documentElement.clientHeight&&!isNaN(t.document.documentElement.clientHeight)&&(e.height=t.document.documentElement.clientHeight),t.innerWidth&&!isNaN(t.innerWidth)&&(e.width=Math.min(e.width,t.innerWidth)),t.innerHeight&&!isNaN(t.innerHeight)&&(e.height=Math.min(e.height,t.innerHeight)),e.area=e.height*e.width,e}function m(t){var e=y(window.top),i=t.getBoundingClientRect(),n=-1,r=-1;if(e.area===1/0)return{error:"Failed to determine viewport",horizontalPer:0,verticalPer:0};var a=function t(e,i){var n=i,r=i.parent,a={left:0,right:0,top:0,bottom:0};if(e){var o=e.getBoundingClientRect();n!==r&&(a=t(n.frameElement,r)),a={left:o.left+a.left,right:o.right+a.left,top:o.top+a.top,bottom:o.bottom+a.top}}return a}(t,window);try{n=a.bottom<0||a.top>e.height?0:a.top<e.height&&a.bottom>e.height?(e.height-a.top)/i.height*100:a.top<0&&0<a.bottom?a.bottom/i.height*100:100,r=a.right<0||a.left>e.width?0:a.right<e.width&&a.left>e.width?(e.width-a.right)/i.width*100:a.left<0&&0<a.right?a.right/i.width*100:100}catch(t){return{error:"Failed to calculate viewability: "+t.message,horizontalPer:0,verticalPer:0}}return{horizontalPer:r,verticalPer:n}}var w,v,S=function(){function s(t,e){var i=e.getAdTech,n=e.getVideoSlot,r=e.getAdBlock,a=e.getMediaId,o=e.getPlayerId;h(this,s),this.options={wtUrl:"https://c.watchingthat.com/v4",debug:!1},this.sessionStartTime=0,this.loopIdx=0,this.requiredData={},this.firstTimeData=null,this.firstTimeDataSent=!1,this.options=c(this.options,t),this.getAdTech=i,this.getVideoSlot=n,this.getAdBlock=r,this.getMediaId=a,this.getPlayerId=o,this.stream=new g({endpoint:this.options.wtUrl,debug:this.options.debug}),(f=d.call(null,"WTAT.core",this.options.debug))("version",this.options.v),this.onEvent=this.onEvent.bind(this),this.createSession=this.createSession.bind(this),this.gatherFirstTimeData=this.gatherFirstTimeData.bind(this),this.sendData=this.sendData.bind(this),this.gatherData=this.gatherData.bind(this),this.replaceUrlMacros=this.replaceUrlMacros.bind(this),this.createSession()}return s.prototype.onEvent=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};f("start.onEvent",t.type),this.sendData(t)},s.prototype.createSession=function(){for(var t="",e=0;e<12;e++)t+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXZY01234567890".charAt(Math.floor(64*Math.random()));return this.sessionId=Date.now()+"-"+t,this.sessionStartTime=Date.now(),this.loopIdx+=1,this.requiredData={dv:4,clientId:this.options.clientId,clientSecret:this.options.clientSecret,rid:this.sessionId,idx:this.loopIdx,mediaId:this.getMediaId(),playerId:this.getPlayerId()},this.firstTimeData=this.gatherFirstTimeData(),this.firstTimeDataSent=!1,this.sessionId},s.prototype.gatherFirstTimeData=function(){var t=function(){var t=0,e=0,i=0,n=void 0;try{t=(n=y(window.top)).width,e=n.height,i=1}catch(t){f("getWindowWH catch 1:",t.message)}if(!t){var r=window;try{for(;r.parent&&r!==r.parent;)t=(n=y(window.parent)).width,e=n.height,r=r.parent}catch(t){f("getWindowWH catch 2:",t.message)}}return[t,e,i]}(),e={type:"init",src:this.options.src,v:this.options.v,adTech:this.getAdTech(),aBl:this.getAdBlock(),ww:t[0],wh:t[1],fif:t[2],pu:function(t){var e=document.referrer;!e&&t&&(e=document.documentURI);try{(window.location===window.parent.location||!e&&document.location&&document.location.href)&&(e=document.location.href)}catch(t){f("gatherData pu set to referrer:",e,t.message)}return e}(t[2])};try{var i=this.getVideoSlot();if(i){var n=i.getBoundingClientRect();e.w=n.width,e.h=n.height}}catch(t){f("gatherData ERROR reading ad WxH:",t.message)}return e},s.prototype.sendData=function(t){this.firstTimeDataSent||(this.firstTimeDataSent=!0,this.stream.push(this.gatherData(this.firstTimeData)));var e=this.gatherData(t);this.stream.push(e)},s.prototype.gatherData=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=function(t){if(!t)return-1;var e={percentObscured:0,percentViewable:0,acceptedViewablePercentage:50,viewabilityStatus:!1,duration:0,cssInvisible:!1,domObscured:!1,secureIFrame:!1};try{var i=t.getBoundingClientRect();242500<=i.width*i.height&&(e.acceptedViewablePercentage=30);var n=window.getComputedStyle(t,null),r=n.getPropertyValue("visibility"),a=n.getPropertyValue("display");if("hidden"!==r&&"none"!==a||(e.cssInvisible=!0),e.cssInvisible)return 0;e.percentObscured=e.percentObscured||0;var o={};try{window.top.innerWidth||window.top.document.documentElement.clientWidth||window.top.document.body.clientWidth?o=m(t):e.secureIFrame=!0}catch(t){e.secureIFrame=!0}return o.error||e.secureIFrame||(e.percentViewable=(o.verticalPer-e.percentObscured)*(o.horizontalPer-e.percentObscured)/100),e.percentViewable||0}catch(t){return-1}}(this.getVideoSlot());return c({},t,this.requiredData,{per:e,cst:Date.now()-(this.sessionStartTime||0)})},s.prototype.replaceUrlMacros=function(t){if(!t)return t;if("string"!=typeof t)return t;var e=this.gatherData(this.firstTimeData);return t.replace(/\[wt_ad_width]/g,e.w).replace(/\[wt_ad_width_label]/g,"wt_ad_width").replace(/\[wt_ad_height]/g,e.h).replace(/\[wt_ad_height_label]/g,"wt_ad_height").replace(/\[wt_per]/g,String(e.per)).replace(/\[wt_per_label]/g,"wt_per").replace(/\[wt_page_url]/g,encodeURIComponent(e.pu)).replace(/\[wt_page_url_unenc]/g,e.pu).replace(/\[wt_page_url_label]/g,"wt_page_url").replace(/\[wt_fif]/g,String(e.fif)).replace(/\[wt_fif_label]/g,"wt_fif").replace(/\[wt_win_width]/g,String(e.ww)).replace(/\[wt_win_width_label]/g,"wt_win_width").replace(/\[wt_win_height]/g,String(e.wh)).replace(/\[wt_win_height_label]/g,"wt_win_height").replace(/\[wt_timestamp]/g,String(Date.now()))},s}(),b={pre:"preroll",post:"postroll",mid:"midroll"},_=function(){function i(t){var r=this,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(h(this,i),this.playSent=!1,this.playingSent=!1,this.efqSent=!1,this.esqSent=!1,this.etqSent=!1,this.c25Sent=!1,this.c50Sent=!1,this.c75Sent=!1,this.c95Sent=!1,this.SHORT_NAME="jwp",this.PLAYER_EVENTS={adRequest:function(t){var e={type:"serve",originalAdURL:t.tag};return t.ima&&t.ima.ad&&(e.adId=t.ima.ad.g.adId,e.adSys=t.ima.adsystem,e.adAN=t.ima.ad.g.advertiserName,e.adDID=t.ima.ad.g.dealId,e.adWId=t.ima.ad.g.adWrapperIds.join(","),e.adWSys=t.ima?t.ima.ad.g.adWrapperSystems.join(","):void 0,e.adMU=t.ima?t.ima.ad.g.mediaUrl:void 0),t.adposition&&(e.adType=b[t.adposition]),r.options.sendDebug&&(e.debug="",t.tag||(e.debug="missing originalAdURL")),e},adStarted:function(t){var e={type:"sa"};return t.adposition&&(e.adType=b[t.adposition]),e},adImpression:function(t){var e={type:"imp"};return t.adposition&&(e.adType=b[t.adposition]),e},adTime:function(t){var e=Math.round(t.position),i=Math.round(t.duration/4),n={};if(!r.etqSent&&3*i<=e&&(r.etqSent=!0,r.esqSent=!0,r.efqSent=!0,n.type="etq"),!r.esqSent&&2*i<=e&&(r.esqSent=!0,r.efqSent=!0,n.type="esq"),!r.efqSent&&i<=e&&(r.efqSent=!0,n.type="efq"),t.adposition&&(n.adType=b[t.adposition]),n.type)return n},adComplete:function(t){var e={type:"ecp"};return t.adposition&&(e.adType=b[t.adposition]),e},adError:function(t){var e=t.adErrorCode;t.adErrorCode&&2e4<t.adErrorCode&&(e=t.adErrorCode-2e4);var i={type:"error",st:"vpaid",err:String(t.code),err2:String(e)};return t.adposition&&(i.adType=b[t.adposition]),i},adSkipped:function(t){var e={type:"skip"};return t.adposition&&(e.adType=b[t.adposition]),e},beforePlay:function(t){if(!r.playSent){var e={type:"play",autoplay:!(r.playSent=!0)};return"autostart"===t.playReason&&(e.autoplay=!0),e}},play:function(){if(!r.playingSent)return r.playingSent=!0,{type:"c0"}},time:function(t){if(r.playingSent){var e=Math.floor(100*t.position/t.duration);if(!r.c95Sent&&95<=e)return r.c95Sent=!0,r.c75Sent=!0,r.c50Sent=!0,r.c25Sent=!0,{type:"c95"};if(!r.c75Sent&&75<=e)return r.c75Sent=!0,r.c50Sent=!0,r.c25Sent=!0,{type:"c75"};if(!r.c50Sent&&50<=e)return r.c50Sent=!0,r.c25Sent=!0,{type:"c50"};if(!r.c25Sent&&25<=e)return r.c25Sent=!0,{type:"c25"}}}},this.getDebugData=function(){return{}},this.player=t,this.options=e,this.options.src=this.SHORT_NAME,"debug"===this.options.debug)debugger;this.log=d.call(null,"WTAT.bcp",!!this.options.debug),this.start=this.start.bind(this),this.sendData=this.sendData.bind(this),this._onPlayerEvent=this._onPlayerEvent.bind(this),this.getAdTech=this.getAdTech.bind(this),this.getVideoSlot=this.getVideoSlot.bind(this),this.getMediaId=this.getMediaId.bind(this),this.getPlayerId=this.getPlayerId.bind(this),this.getAdBlock=this.getAdBlock.bind(this),this.utils=new S(e,{getAdTech:this.getAdTech,getVideoSlot:this.getVideoSlot,getAdBlock:this.getAdBlock,getDebugData:this.getDebugData,getMediaId:this.getMediaId,getPlayerId:this.getPlayerId})}return i.prototype.start=function(){var e=this;Object.keys(this.PLAYER_EVENTS).forEach(function(t){e.player.on(t,e._onPlayerEvent)}),this.player.on("beforeComplete",function(){e.playSent=!1,e.playingSent=!1,e.efqSent=!1,e.esqSent=!1,e.etqSent=!1,e.c25Sent=!1,e.c50Sent=!1,e.c75Sent=!1,e.c95Sent=!1,e.utils.createSession()})},i.prototype.sendData=function(t){this.utils.sendData(t)},i.prototype._onPlayerEvent=function(t){if(this.PLAYER_EVENTS[t.type])if("function"==typeof this.PLAYER_EVENTS[t.type]){var e=this.PLAYER_EVENTS[t.type](t);if(e)return this.utils.onEvent(e,t)}else this.utils.onEvent(this.PLAYER_EVENTS[t.type],t);else this.log("Untracked player event triggered",t.type)},i.prototype.cleanup=function(){delete this.utils,delete this.log,this.player=null},i.prototype.getAdTech=function(){return this.player.getRenderingMode()},i.prototype.getVideoSlot=function(){return this.player.getContainer()},i.prototype.getMediaId=function(){return this.player.getPlaylistItem().mediaid},i.prototype.getPlayerId=function(){return this.player.getConfig().pid},i.prototype.getAdBlock=function(){return+this.player.getAdBlock()},i}(),I="wtatJW",E="1.1.0",T=((v={modules:(w={},w[I]=_,w)})[I]={},v),D={};try{var A=localStorage.getItem("wtDebug"),P=localStorage.getItem("wtUrl");A&&(D.debug=A),P&&(D.wtUrl=P)}catch(t){}var R=function(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=arguments[1],r=void 0;(r=t?"string"==typeof t?jwplayer(t):t:jwplayer()).on("ready",function(){var i={v:E};Object.keys(T.modules).forEach(function(t){var e=c({},i,T[t],n[t],D);t===I&&n.clientId&&n.clientSecret&&c(e,n,D),r[t]=new _(r,e),r[t].start()})})};return R.VERSION=E,R});
